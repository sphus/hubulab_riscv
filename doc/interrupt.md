## riscv的分支预测
riscv机构要求在没有硬件分支预测功能的情况下，采用默认的静态分支预测:即向后跳转预测为"跳"，即向前跳转预测为"不跳"
## 特权模式
3种特权模式：机器(Machine)，监督(Supervisor)，用户(User)
> - 如果要上操作系统可能要设置3种模式
> - 存储器地址管理（MPU,MMU），虚拟内存
## CSR寄存器
> - 在附录B里有相关内容

## 异常
- 广义异常
  - 同步异常(能精准定位具体执行指令的异常，常常是内部指令错误引起)
  - 异步异常(不能精准定位具体执行指令的异常，常常是外部中断引起)
    - 精确异步异常
      - 即响应异常后处理器处于指令执行完之后的状态
    - 非精确异步异常
      - 即响应异常后处理器处于指令执行中或者其他模糊状态

常见异常列表
![alt text](image.png)

## 异常处理流程
- ![alt text](image-6.png)
- ![alt text](image-10.png)

## 异常相关处理流程和CSR寄存器(机器模式)
- mtvec(机器模式异常进入基地址寄存器)(预先写好的)
  - ![alt text](image-1.png)
  - ![alt text](image-7.png)
  - ![alt text](image-9.png)
### 进入异常plicpli
- mcause(机器模式异常原因寄存器)(发生中断就会硬件更新)
  - 定义12种中断和16种异常 
  - ![alt text](image-8.png) 
- mepc(机器模式异常返回地址寄存器)(发生中断就会硬件更新)
  - 为什么发生中断时更新为下一条未执行的指令地址(当前被打断的程序该怎么办)
  - 为什么发生中断时更新为下一条未执行的指令地址
- mtval(存下异常的存储访问地址，异常的指令，硬件更新)
- mstatus(机器模式状态寄存器，硬件更新)
  - ![alt text](image-2.png)
  - mie:中断的全局使能位(发生中断时，mie会自动清零)
  - mpie:当异常发生时，存下异常发生前的mie
  - mpp:当异常发生时，存下异常发生前的工作模式
### 退出异常
- MRET(SRET,URET):在软件上使用异常退出指令
  - 硬件会将mepc的值给到pc,同时硬件更新mstatus
### 异常服务函数

## 中断类型
- 外部中断 
- 计时器中断
- 软件中断
- 调试中断

### 中断屏蔽
- 狭义的异常不可屏蔽，狭义的中断可屏蔽
  - mie(中断使能寄存器,部分中断):(EIE(外部中断),TIE(定时中断),SIE(软件中断))
    - ![alt text](image-3.png)
    - 软件可读可写
### 中断等待
- mip(中断等待寄存器):(EIP(外部等待),TIP(定时等待),SIP(软件等待))
  - ![alt text](image-4.png)
  - 软件只读
  - 即使mie的EIE=0(屏蔽外部中断),但外部中断到来时，MEIP依然会为1
### 中断优先级
- 优先级由高到低：软件中断，外部中断，定时中断。调试中断比较特殊，不做讨论
### 中断嵌套
- <font color="red">riscv架构硬件上不支持嵌套:有中断发生时，mstatus的mie为0,即关闭全局中断。</font>
- <font color="red">软件可以在进入中断服务函数时，将mstatus的mie的值强行改写为1</font>
### 中断控制器(PLIC)


## 广义异常处理(E200)
- ![alt text](image-5.png)
- clint:产生软件中断(msip)与定时中断(mtime,mtimecmp,mcounterstop)
- plic:产生外部中断(多个中断源选择一个输入)
- debug:调试中断
- 异常的来源:ALU的指令
- 交付:指令交付点
  - 优先级:中断比同步异常的优先级高？
   
## 调试
- GDB软件(19.4节)

## 触发中断的指令
- 同步异常：mepc存下的是异常指令本身的地址，所以异常处理后要对mpec+4
- 异步异常：不能明确具体哪个指令，所以要让已经执行的指令执行完成，再将未执行指令的地址存入mepc，返回时不用+4

## 三级级流水线异常设计
#### 初始化csr寄存器
- mstatus = 32'h00000088;
- mtvec赋值为要跳转的目标地址(通过int_type判断) 
- 

  

## 五级流水线异常设计
#### 1.异常来源
- 